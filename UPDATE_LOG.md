# 功能更新说明 - 表结构查看与注释编辑

## 🎉 新增功能

### 1. 表结构详情查看
- ✅ 点击依赖树中的任何表或视图节点，右侧面板显示详细信息
- ✅ 显示完整的表结构信息：
  - 字段名称
  - 数据类型（完整类型信息）
  - 是否可空（YES/NO 标签）
  - 默认值
  - 字段注释

### 2. 注释编辑功能
- ✅ **表注释编辑**：可以为整个表添加或修改注释说明
- ✅ **字段注释编辑**：每个字段都有独立的注释输入框
- ✅ **自动保存**：点击"保存注释"按钮，所有修改会被保存
- ✅ **持久化存储**：注释数据保存在 `table_comments.json` 文件中

### 3. 界面优化
- ✅ **左右分栏布局**：
  - 左侧 40%：依赖关系树
  - 右侧 60%：表结构详情面板
- ✅ **选中状态高亮**：点击的节点会有明显的高亮效果
- ✅ **响应式设计**：自适应不同屏幕尺寸
- ✅ **美观的表格**：专业的表格样式展示字段信息

## 📸 界面预览

### 布局结构
```
┌─────────────────────────────────────────────────────────┐
│                    页面标题                              │
├──────────────────────┬──────────────────────────────────┤
│                      │                                  │
│   依赖关系树          │      表结构详情面板               │
│                      │                                  │
│   📊 live_base_view  │   表名: live_base                │
│   ├─ 📋 jl_user      │   表注释: [可编辑输入框]          │
│   ├─ 📊 live_sales   │                                  │
│   └─ 📋 live_base ✓  │   字段列表:                       │
│                      │   ┌────────────────────────────┐ │
│                      │   │ 字段名 │ 类型 │ 注释 [编辑] │ │
│                      │   ├────────────────────────────┤ │
│                      │   │ id    │ INT  │ [输入框]    │ │
│                      │   │ name  │ VARCHAR│[输入框]   │ │
│                      │   └────────────────────────────┘ │
│                      │                                  │
│                      │   [保存注释] 按钮                 │
└──────────────────────┴──────────────────────────────────┘
```

## 🚀 使用方法

### 步骤 1：启动服务
```bash
python web_view_analyzer.py
```

### 步骤 2：分析视图
1. 在左侧输入框输入视图名称
2. 点击"分析"按钮
3. 查看依赖关系树

### 步骤 3：查看表结构
1. 点击依赖树中的任何表或视图节点
2. 右侧面板自动显示该表的详细结构
3. 查看所有字段信息

### 步骤 4：编辑注释
1. 在"表注释"输入框中输入表的整体说明
2. 在每个字段的"注释"列输入框中添加字段说明
3. 点击底部的"💾 保存注释"按钮
4. 看到"✓ 保存成功"提示

### 步骤 5：查看已保存的注释
- 下次点击同一个表时，之前保存的注释会自动显示
- 注释数据保存在项目目录的 `table_comments.json` 文件中

## 📁 新增文件

### 1. table_comments.json
注释数据存储文件，格式如下：

```json
{
  "donggua.live_base": {
    "table_comment": "直播基础信息表",
    "column_comments": {
      "id": "主键ID",
      "anchor_id": "主播ID",
      "room_name": "直播间名称",
      "start_time": "开播时间"
    },
    "updated_at": "2026-01-27T17:30:00"
  }
}
```

## 🔧 技术实现

### 后端新增 API

#### 1. 获取表结构
```
POST /api/table_structure
Request: {"table_name": "live_base"}
Response: {
  "table_name": "live_base",
  "table_type": "table",
  "table_comment": "直播基础信息表",
  "columns": [
    {
      "name": "id",
      "data_type": "int",
      "column_type": "int(11)",
      "nullable": false,
      "default": null,
      "db_comment": "",
      "custom_comment": "主键ID"
    }
  ]
}
```

#### 2. 保存注释
```
POST /api/save_comments
Request: {
  "table_name": "live_base",
  "table_comment": "直播基础信息表",
  "column_comments": {
    "id": "主键ID",
    "anchor_id": "主播ID"
  }
}
Response: {"success": true, "message": "保存成功"}
```

### 前端新增功能

#### 1. 双面板布局
- 使用 Flexbox 实现左右分栏
- 左侧固定 40% 宽度，右侧占据剩余空间
- 独立滚动区域

#### 2. 节点点击事件
```javascript
function showTableDetails(tableName) {
    // 调用 API 获取表结构
    // 渲染详情面板
    // 高亮选中节点
}
```

#### 3. 注释保存
```javascript
function saveComments() {
    // 收集表注释
    // 收集所有字段注释
    // 调用保存 API
    // 显示成功/失败提示
}
```

## 🎨 样式特点

### 颜色方案
- **主色调**：紫色渐变 (#667eea → #764ba2)
- **视图标识**：蓝色 (#1976d2)
- **表标识**：绿色 (#388e3c)
- **可空标签**：绿色 (YES) / 红色 (NO)
- **选中状态**：浅紫色背景 (#e3f2fd)

### 交互效果
- ✨ 节点悬停：轻微位移 + 背景变化
- ✨ 输入框聚焦：紫色边框高亮
- ✨ 按钮悬停：向上浮动效果
- ✨ 保存成功：绿色提示消息
- ✨ 加载状态：旋转动画

## 📊 使用场景

### 场景 1：数据字典维护
为团队维护完整的数据字典：
1. 分析所有视图的依赖关系
2. 逐个表添加注释说明
3. 为每个字段添加业务含义
4. 导出 `table_comments.json` 作为文档

### 场景 2：新人培训
帮助新人快速了解数据库结构：
1. 输入核心视图名称
2. 查看依赖的所有表
3. 点击每个表查看详细字段说明
4. 理解数据流转关系

### 场景 3：影响分析
评估字段修改的影响范围：
1. 找到包含该字段的表
2. 查看哪些视图依赖这个表
3. 评估修改影响的视图数量
4. 制定修改方案

## ⚠️ 注意事项

### 1. 注释数据存储
- 注释保存在本地 `table_comments.json` 文件
- 不会修改数据库中的 COMMENT
- 建议定期备份该文件
- 可以将该文件纳入版本控制

### 2. 权限要求
- 需要有查询 `information_schema.TABLES` 的权限
- 需要有查询 `information_schema.COLUMNS` 的权限
- 不需要修改表结构的权限

### 3. 性能考虑
- 表结构信息按需加载（点击时才查询）
- 注释数据缓存在内存中
- 大表可能需要稍长的加载时间

## 🔄 版本对比

### 旧版本
- ✓ 查看依赖关系树
- ✓ 可折叠展开节点
- ✗ 无法查看表结构
- ✗ 无法添加注释

### 新版本
- ✓ 查看依赖关系树
- ✓ 可折叠展开节点
- ✓ **查看完整表结构**
- ✓ **编辑表和字段注释**
- ✓ **持久化保存注释**
- ✓ **双面板布局**

## 📝 后续计划

- [ ] 支持导出注释为 Markdown 文档
- [ ] 支持批量导入注释（从 Excel/CSV）
- [ ] 添加注释搜索功能
- [ ] 支持注释历史版本管理
- [ ] 添加字段关系图可视化
- [ ] 支持多人协作编辑注释

## 🆘 常见问题

**Q: 注释保存后在哪里？**
A: 保存在项目目录的 `table_comments.json` 文件中

**Q: 注释会写入数据库吗？**
A: 不会，只保存在本地 JSON 文件中，不修改数据库

**Q: 如何备份注释？**
A: 直接复制 `table_comments.json` 文件即可

**Q: 多人如何共享注释？**
A: 将 `table_comments.json` 文件放入 Git 等版本控制系统

**Q: 点击节点没反应？**
A: 检查浏览器控制台是否有错误，确认后端服务正常运行

---

**更新日期**: 2026-01-27
**版本**: v2.0
